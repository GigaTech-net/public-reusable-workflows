---
name: Main PR workflow

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
    branches:
      - main
      - master

permissions:
  contents: read
  pull-requests: read

# cancel any previously-started, yet still active runs of this workflow
# on the same branch
concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

env:
  NEEDS_REVIEW_LABEL: "needs-human-review"

jobs:
  # Efficient combined job using composite actions for quick checks
  quality-checks:
    runs-on: ubuntu-latest
    outputs:
      current-version: ${{ steps.setup.outputs.current-version }}
      current-v-version: ${{ steps.setup.outputs.current-v-version }}
      version: ${{ steps.setup.outputs.version }}
      v-version: ${{ steps.setup.outputs.v-version }}
      pre-release-label: ${{ steps.setup.outputs.pre-release-label }}
      branch: ${{ steps.setup.outputs.branch }}
      NEEDS_REVIEW_LABEL: ${{ env.NEEDS_REVIEW_LABEL }}
    steps:
      - name: Setup GitHub token
        uses: GigaTech-net/reusable-workflows/.github/actions/setup-token@main
        with:
          app_id: ${{ secrets.KEYROTATION_APPID_GT_GH }}
          private_key: ${{ secrets.KEYROTATION_PVTKEY_GT_GH }}

      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      # Combined setup, checkout, version detection, and branch extraction
      - name: Setup workflow environment
        id: setup
        uses: >-
          GigaTech-net/reusable-workflows/.github/actions/setup-workflow@main

      # Validate PR title using composite action
      - name: Validate PR title
        uses: >-
          GigaTech-net/reusable-workflows/.github/actions/validate-pr-title@main

      # Secret scan using composite action
      - name: Secret scan
        uses: >-
          GigaTech-net/reusable-workflows/.github/actions/secret-scan@main

      # Spellcheck using composite action
      - name: Spellcheck
        uses: GigaTech-net/reusable-workflows/.github/actions/spellcheck@main
        with:
          github_token: ${{ env.GITHUB_TOKEN }}

      - name: dependency check
        uses: GigaTech-net/reusable-workflows/.github/actions/dependency-check@main
        id: dependency-check
        with:
          artifact_name: ${{ env.ARTIFACT_NAME }}-${{ github.sha }}
          retention_days: ${{ env.RETENTION_DAYS }}
          working_directory: "."
          oss_index_user: ${{ secrets.SONATYPE_OSS_INDEX_USER }}
          oss_index_api_token: ${{ secrets.SONATYPE_OSS_INDEX_API_TOKEN }}

  complexity:
    name: Check Complexity
    needs: quality-checks
    permissions:
      contents: write
      pull-requests: write
    uses: >-
      GigaTech-net/reusable-workflows/.github/workflows/rw-complexity.yaml@main
    with:
      needsReviewLabel: >-
        ${{ needs.quality-checks.outputs.NEEDS_REVIEW_LABEL }}
    secrets: inherit

  human-review:
    name: Check if human review is needed
    needs: [quality-checks, complexity]
    permissions: read-all
    uses: >-
      GigaTech-net/reusable-workflows/.github/workflows/rw-checkreview.yaml@main
    with:
      needsReviewLabel: ${{ needs.quality-checks.outputs.NEEDS_REVIEW_LABEL }}
    secrets: inherit

  enable-auto-merge:
    name: Enable Auto Merge
    needs: [human-review, quality-checks, complexity]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Setup GitHub token
        uses: GigaTech-net/reusable-workflows/.github/actions/setup-token@main
        with:
          app_id: ${{ secrets.KEYROTATION_APPID_GT_GH }}
          private_key: ${{ secrets.KEYROTATION_PVTKEY_GT_GH }}

      - name: Debug - Show conditions
        run: |
          echo "PR Author: ${{ github.event.pull_request.user.login }}"
          human_review="${{ needs.human-review.outputs.human_review_needed }}"
          echo "Human review needed: $human_review"
          echo "Complexity result: ${{ needs.complexity.outputs.complex }}"
          echo "Quality checks result: ${{ needs.quality-checks.result }}"

      - name: Enable auto merge for regular PRs (not dependabot)
        if: |
          github.event.pull_request.user.login != 'dependabot[bot]' &&
          needs.human-review.outputs.human_review_needed == 'false'
        run: |
          {
            gh pr merge --auto --merge "$PR_URL"
          }
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GT_DEVSECOPS_PAT }}

      - name: Enable auto merge for dependabot PRs meeting conditions
        if: |
          github.event.pull_request.user.login == 'dependabot[bot]' &&
          (needs.complexity.outputs.complex == 'false' ||
            needs.complexity.outputs.complex == '') &&
          needs.human-review.outputs.human_review_needed == 'false' &&
          needs.quality-checks.result == 'success'
        run: |
          {
            echo "✅ Dependabot PR meets auto-merge criteria:"
            echo "  - Not complex (files < 6, lines < 200)"
            echo "  - No human review needed"
            echo "  - Quality checks passed"
            gh pr merge --auto --merge "$PR_URL"
          }
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Dependabot PR requires manual review
        if: |
          github.event.pull_request.user.login == 'dependabot[bot]' &&
          (needs.complexity.outputs.complex == 'true' ||
            needs.human-review.outputs.human_review_needed == 'true' ||
            needs.quality-checks.result != 'success')
        run: |
          {
            echo "⚠️  Dependabot PR requires manual review due to:"
            echo "  - Complex: ${{ needs.complexity.outputs.complex }}"
            human_review="${{ needs.human-review.outputs.human_review_needed }}"
            echo "  - Human review needed: $human_review"
            echo "  - Quality checks result: ${{ needs.quality-checks.result }}"
            echo ""
            echo "Auto-merge skipped for safety."
          }

  auto-approve:
    name: Auto approve PR
    needs: [human-review, quality-checks, complexity]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: |
      needs.human-review.outputs.human_review_needed == 'false' &&
      (needs.complexity.outputs.complex == 'false' ||
       needs.complexity.outputs.complex == '') &&
      needs.quality-checks.result == 'success'
    steps:
      - name: Setup GitHub token
        uses: GigaTech-net/reusable-workflows/.github/actions/setup-token@main
        with:
          app_id: ${{ secrets.KEYROTATION_APPID_GT_GH }}
          private_key: ${{ secrets.KEYROTATION_PVTKEY_GT_GH }}

      - name: Approve the PR if auto-merge criteria met
        run: |
          echo "✅ Auto-approving PR - all conditions met"
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
